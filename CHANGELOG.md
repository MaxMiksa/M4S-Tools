# 版本更迭说明

## v1.3.0 – 启动体验与混流性能升级

### 功能 1：异步 FFmpeg 检测，消除启动卡顿
- **总结**：界面组件立即渲染，FFmpeg 健康检查转入后台线程，软件打开时不再白屏 2–3 秒。
- **解决的痛点或问题**：打包后的 EXE 需等待 `ffmpeg -version` 完成才能显示窗口，导致明显卡顿。
- **功能变更详情**：
  - `gui.py` 在构造函数内直接调用 `setup_ui()`，随后使用 `self.root.after(200, self._start_ffmpeg_check)` 延迟启动后台检测。
  - 日志面板即时输出 “[FFmpeg] 检查中... | Checking FFmpeg availability...” 提示，让用户知情。
- **技术实现细节**：
  - `_start_ffmpeg_check` 使用 `threading.Thread` 调用 `M4SProcessor.check_ffmpeg_available()`，完成后由 `_on_ffmpeg_check_finished` 在主线程中初始化 `M4SProcessor`。
  - 用 `self.processor_ready` / `self.ffmpeg_checking` 标记状态，避免重复检测并保证线程安全。

### 功能 2：处理前的初始化守卫
- **总结**：所有按钮在执行任务前调用 `_ensure_processor_ready()`，必要时弹出双语提示并阻止误触。
- **解决的痛点或问题**：FFmpeg 尚未初始化或正在安装时，用户点击操作会报错或没有即时反馈。
- **功能变更详情**：
  - `_run_task` 中在锁定输出目录后调用 `_ensure_processor_ready()`，若 FFmpeg 仍在初始化就通过 `messagebox` 提示。
  - 若后台尚未开始检测，`_ensure_processor_ready()` 会自动重新触发 `_start_ffmpeg_check()`。
- **技术实现细节**：
  - `_ensure_processor_ready` 检查 `self.processor_ready` 与 `self.processor`，并复用 `self.t["ffmpeg_wait"]` 文案保证中英双语一致。
  - 通过引入状态标记，避免在用户操作密集场景下重复创建 FFmpeg 实例。

### 功能 3：混流直接复制流，极大缩短耗时
- **总结**：FFmpeg 混流命令改为 `-c:v copy -c:a copy`，不再重新编码音频轨，实际耗时从 50–60 秒降至理论的几秒。
- **解决的痛点或问题**：旧版强制 AAC 转码，34 MB 的音频流每次都要重新编码，令混流阶段明显拖慢。
- **功能变更详情**：
  - 用户将 95 MB 视频与 34 MB 音频导入后，混流过程只做封装转换，立即得到包含画面和声音的 MP4。
  - README 中“性能提升报告”记录了这一改动及实测收益，方便团队回顾。
- **技术实现细节**：
  - `m4s_processor.py` 的 `merge_av` 只保留 `-y` 覆盖参数，去掉 `-strict experimental` 及 AAC 编码选项。
  - 因为音频流直接复制，CPU 不再参与编码，大幅降低延迟与功耗。

### 功能 4：日志字体与 FFmpeg 安装界面统一
- **总结**：日志窗口改用微软雅黑等中文友好字体并恢复双语提示；FFmpeg 安装对话框采用与主界面一致的圆角卡片、品牌色和提示布局。
- **解决的痛点或问题**：旧版日志内中文显示为 “???”；安装窗口使用默认 Tk 样式，观感与主界面割裂。
- **功能变更详情**：
  - `font_mono` 改为 `Microsoft YaHei UI`，FFmpeg 检查日志统一输出 “检查中 / 已就绪” 双语文本。
  - 安装对话框使用 brand 色块图标、路径卡片、进度条与主按钮，附带双语提示语与自动化说明。
- **技术实现细节**：
  - `_start_ffmpeg_check` / `_on_ffmpeg_check_finished` 直接写入中文字符，确保 Windows 控制台与 UI 均可渲染。
  - `install_ffmpeg_dialog` 以 `CTkFrame` 组合卡片、信息块与进度条，按钮采用 `COLORS["brand"]` 配色并复用主界面字体体系。

### 功能 5：主界面取消进度条并统一深色主题按键
- **总结**：去除了主面板的进度条，保留安装向导进度展示，并在深色模式下统一「仅合并视频/音频」「选择文件」「更改路径」等按键的底色和 hover 反馈。
- **解决的痛点或问题**：1) 进度条几乎恒为 0，提供的信息有限且占据空间；2) 深色主题下部分按钮与背景颜色一致、悬停时无反馈，易给人“无响应”的错觉。
- **功能变更详情**：
  - 删除主 UI 中的 `CTkProgressBar` 及其 start/stop 调用，界面更紧凑。
  - 新增 `COLORS["secondary_btn"]` / `["secondary_hover"]` 配色，并应用到文件面板的「选择文件」与路径栏「更改路径」按钮，确保深浅对比；同时给「仅合并视频/音频」按钮指定相同颜色，统一交互体验。
- **技术实现细节**：
  - 控制逻辑只剩安装对话框使用进度条，主界面 `_run_task` / `_on_finish` 不再引用 `self.progress_bar`。
  - 通过在颜色映射表中声明二级按钮配色，再将 `fg_color` 与 `hover_color` 绑定到这些值，保证浅/深主题拥有各自的色值组合。

## v1.2.0 – 精准输出与桌面友好默认

### 功能 1：时间戳命名与可追溯输出
- **总结**：所有输出统一采用 `Merged_*` / `Muxed_*_YYYY-MM-DD_HH-MM-SS.mp4` 格式，确保每次运行的结果都可以追踪与区分。
- **解决的痛点或问题**：传统固定文件名会被覆盖、难以判断生成顺序，也不利于在多次混流后定位最终版本。
- **功能变更详情**：
  - 视频合并、音频合并、音视频混流默认生成包含年月日 + 24 小时时间戳的文件名。
  - README 中文/英文档同步更新示例，让用户了解输出命名规律。
  - 任何手动指定输出名的调用仍可覆盖默认值，满足脚本集成需求。
- **技术实现细节**：
  - 在 `m4s_processor.py` 中新增 `_timestamp_str` 和 `_generate_output_name`，并在 `merge_video_segments`、`merge_audio_segments`、`merge_av` 内复用。
  - 时间格式统一采用 `datetime.now().strftime("%Y-%m-%d_%H-%M-%S")`，避免跨平台的非法字符。
  - 外部调用若传入 `output_name` 参数则绕过默认规则，兼容旧自动化脚本。

### 功能 2：临时目录智能混流与单文件直通
- **总结**：一键流程与 GUI 混流按钮会智能判断输入数量，单文件组合直接复用源文件，多段文件在临时目录合并后立即清理。
- **解决的痛点或问题**：旧版总在输出目录留下 `merged_video.mp4`、`merged_audio.mp4` 等中间件，不仅占空间，也造成用户误删、误分发。
- **功能变更详情**：
  - `process_all` 重写后，只要某一侧输入为空则仅返回对应合并结果；同时在双流场景下完全隐藏中间文件。
  - GUI 按钮 `merge_av_direct` 判断文件数量，自动决定“直接复用单文件”或“先在临时目录合并后再混流”。
  - 日志顺序仍旧是「视频合并完成→音频合并完成→开始混流」，保证用户能看到熟悉的进度提示。
- **技术实现细节**：
  - 新增 `_prepare_stream_for_mux`，接收文件列表、临时目录和媒体类型，内部调用对应的 merge 方法或返回原路径。
  - `process_all` 和 GUI 线程任务均使用 `tempfile.TemporaryDirectory()` 管理生命周期，以上下文退出自动删除文件。
  - 混流调用仍执行 `ffmpeg -c:v copy -c:a aac`，但输入路径可能来自临时目录或原始数据。

### 功能 3：桌面优先的输出目录策略
- **总结**：程序启动后默认把输出路径设置到当前用户桌面；若桌面不存在则回退到当前工作目录。
- **解决的痛点或问题**：用户经常忘记修改输出位置，导致结果散落在安装目录或命令行所在目录，查找不便。
- **功能变更详情**：
  - 文案从 “Auto (Current Directory)” 升级为 “Desktop (Default)” / “桌面 (默认)”。
  - 每次调用 `_run_task` 时都会检查 `self.output_dir`，为空则自动恢复到桌面路径，并立即刷新 UI。
- **技术实现细节**：
  - 新方法 `_get_default_output_dir` 使用 `Path.home() / "Desktop"` 作为主路径，结合 `exists()` 做兜底。
  - GUI 初始化阶段就调用该方法，保证首次打开软件即可看到桌面路径。
  - 输出路径变化后调用 `_update_path_label` 即时同步多语言标签。

### 功能 4：文档同步更新
- **总结**：README 中文/英文版同步说明桌面默认路径、时间戳命名与新示例截图（v1.2.0）。
- **解决的痛点或问题**：公开文档若停留在旧描述，会让用户产生版本混乱或误以为功能缺失。
- **功能变更详情**：
  - 顶部标题、截图/GIF 路径、操作步骤中的输出说明等均更新至 v1.2.0。
  - 输出文件描述部分加入详细命名格式以及仅留下成品文件的说明。
- **技术实现细节**：
  - 所有媒体引用路径同步改为 `Presentation Videos/v1.2.0/…`，为后续版本留出扩展空间。
  - 中英文 README 结构保持一致，方便翻译与 diff。

## v1.1.0 – UI/UX 全面重构与双语体验

### 功能 1：现代化界面与布局
- **总结**：界面采用全新卡片式设计、圆角控件与自适应布局，整体观感与交互体验焕然一新。
- **解决的痛点或问题**：旧版窗口控件过于基础，组件分布拥挤，难以在不同分辨率下获得一致体验。
- **功能变更详情**：
  - 主面板 `main_frame`、卡片 `main_card`、文件区 `CTkScrollableFrame` 等进行了模块化布局。
  - 统一字体与字号（如 `Microsoft YaHei UI`、`Consolas`），提升中文展示效果。
  - 文件列表显示文件大小、自动截断长文件名，配合圆角按钮与提示信息。
- **技术实现细节**：
  - 全面迁移至 `customtkinter` 组件，使用 `pack` + `grid` 混合布局保证扩展性。
  - 色板集中在 `COLORS` 字典，配合 `fg_color`、`hover_color` 控制主题。
  - 通过 `self.ui_refs` 存储控件引用，使批量样式刷新成为可能。

### 功能 2：双语提示与日志系统
- **总结**：软件所有主要文本都支持实时中/英文切换，包括提示、按钮、日志、弹窗与安装流程。
- **解决的痛点或问题**：国际用户无法理解中文提示；国内用户也希望在阅读英文教程时对应界面文案。
- **功能变更详情**：
  - `TRANS` 字典列出所有 UI 文本，`toggle_language` 切换语言并调用 `refresh_text` 更新控件。
  - 日志记录采用 “中文 | English” 双语格式，确保排查问题时可读。
  - FFmpeg 安装对话框也同步展示双语说明、进度信息。
- **技术实现细节**：
  - `refresh_text` 遍历 `self.ui_refs` 更新按钮、标签、提示文本等，避免逐个控件赋值。
  - 异步日志更新使用 `self.log_text` 文本框并在主线程内刷新，防止多线程冲突。
  - 语言按钮文本来自 `TRANS["lang_btn"]`，确保提示与目标语言一致。

### 功能 3：主题切换与视觉一致性
- **总结**：新增 Light/Dark 主题切换，颜色、字体、按钮状态均匹配相应模式。
- **解决的痛点或问题**：在明亮或昏暗环境下缺乏合适主题，用户需自行调整系统设置。
- **功能变更详情**：
  - `toggle_theme` 在 `ctk.set_appearance_mode` 间切换 “Light” 与 “Dark”。
  - 顶部按钮实时更新为 “Dark / Light” 或 “深色模式 / 浅色模式”，与当前主题同步。
- **技术实现细节**：
  - `COLORS` 字典为每个键提供 `(light, dark)` 元组，控件按当前主题取色。
  - 主题按钮的 `command` 触发结尾调用 `refresh_text`，确保语言和主题状态一致。

### 功能 4：安装体验与错误提示增强
- **总结**：FFmpeg 安装流程和错误提示全部提供双语内容，并支持居中、焦点控制、防止误触。
- **解决的痛点或问题**：旧版对话框可能被其他窗口遮挡，且提示只有中文；安装失败时缺少清晰日志。
- **功能变更详情**：
  - 安装窗口 `install_ffmpeg_dialog` 会居中显示、`grab_set` 限制焦点，避免背景窗口误操作。
  - 进度回调利用 `dialog.after` 在主线程更新 UI，日志和弹窗同步记录。
  - 安装成功/失败都会显示中英双语提示并引导用户重启。
- **技术实现细节**：
  - `FFmpegInstaller.install_ffmpeg` 通过回调函数输出阶段、进度、状态，GUI 层以线程方式调用。
  - 所有异常通过 `traceback.format_exc()` 写入日志，便于用户反馈。

## v1.0.0 – 初始功能集

### 功能 1：M4S 视频/音频合并
- **总结**：支持一次选择多个 `.m4s` 片段并按选择顺序合并为完整 MP4。
- **解决的痛点或问题**：手动拼接分段、排序复杂且容易出错。
- **功能变更详情**：
  - 提供独立的“仅合并视频”、“仅合并音频”按钮，用户可独立生成轨道。
  - 文件列表显示顺序、大小，提醒用户确保片段排序正确。
- **技术实现细节**：
  - `m4s_processor.merge_video_segments/merge_audio_segments` 使用 `ffmpeg -f concat -safe 0` 命令。
  - 生成临时 `txt` 列表文件记录绝对路径，并在合并完成后清理。
  - 设定 1 小时超时，防止极端大文件挂起。

### 功能 2：音视频混流与一键自动化
- **总结**：混流模式将处理好的视频与音频合并为单个 MP4，并支持“一键处理”串联合并 + 混流。
- **解决的痛点或问题**：用户需要在命令行多次执行 FFmpeg，流程复杂。
- **功能变更详情**：
  - `merge_av` 默认 `-c:v copy`、`-c:a aac`，确保快速输出且兼容主流播放器。
  - `process_all` 流程：视频合并→音频合并→混流；若某一路不存在则直接返回已有结果。
- **技术实现细节**：
  - 使用 `subprocess.run` 捕获 stdout/stderr，并将 FFmpeg 错误抛出到 GUI。
  - 支持线程化执行，在 GUI 中通过日志和进度条反馈。

### 功能 3：GUI 操作体验
- **总结**：通过 `customtkinter` 结合 `tkinter` 的界面交互完成文件选择、路径设置、日志查看。
- **解决的痛点或问题**：命令行入门门槛高，不适合非技术用户。
- **功能变更详情**：
  - 文件列表采用滚动框展示路径和大小信息，支持清空/重新选择。
  - 日志区域实时输出处理信息，配合 `messagebox` 提示成功或失败。
- **技术实现细节**：
  - 采用 `threading.Thread` 在后台运行耗时任务，防止 GUI 卡死。
  - `_run_task` 方法负责通用的进度条、日志、完成回调封装。

### 功能 4：FFmpeg 自动安装与错误处理
- **总结**：首次启动检测 FFmpeg，缺失时提供下载、解压、PATH 配置全流程；所有阶段都具备可视化错误提示。
- **解决的痛点或问题**：新用户不了解如何安装 FFmpeg，手动配置 PATH 容易出错。
- **功能变更详情**：
  - 安装对话框允许选择路径，显示即时进度条，并在成功后提示重启。
  - 程序运行过程中，如果出现 Python 版本过低、模块缺失、FFmpeg 命令失败等情况，都弹出详细错误框。
- **技术实现细节**：
  - `FFmpegInstaller` 下载压缩包、解压、修改环境变量；GUI 端以线程方式执行并监听回调。
  - `main.py` 入口包含多级 try/except，优先使用 tkinter messagebox，无法创建 GUI 时回退到 Windows MessageBox 或控制台输出。

> 自 v1.2.0 起，任何新版本发布都需要在本文档中追加对应章节，以便追踪功能演进与技术实现。

> 自 v1.2.0 起，任何新版本发布都需要在本文档中追加对应章节，以便追踪功能演进与技术实现。 
